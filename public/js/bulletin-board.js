
const BASE_URL = "https://marlonfajardo.ca/karma/v1";

const result = {
  "Recommended For You": {
  "1": {
  "opportunity_id": 1,
  "employer": "Guildford Library",
  "category": "Literacy, Libraries, and Learning",
  "event_date": "2021-05-30T04:00:00.000Z",
  "poster_id": 2,
  "title": "Library Assistant",
  "description": "Be an assistant at a Library",
  "requirements": "1-2 years experience at a library",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-10T21:46:25.000Z",
  "posted_by": "Karma"
  },
  "5": {
  "opportunity_id": 5,
  "employer": "Team Karma",
  "category": "Environment",
  "event_date": "2021-05-30T04:00:00.000Z",
  "poster_id": 2,
  "title": "Clean Up Crew Member",
  "description": "Clean up the Fraser river. All clothing and equipment provided",
  "requirements": "No requirements",
  "image_url": "https://coconuts.co/wp-content/uploads/2018/03/dirty-river.jpg",
  "post_date": "2021-05-10T22:35:35.000Z",
  "posted_by": "Karma"
  },
  "7": {
  "opportunity_id": 7,
  "employer": "Bonsor Community Center",
  "category": "Sports and Recreation",
  "event_date": "2021-06-22T04:00:00.000Z",
  "poster_id": 2,
  "title": "Camp Assistant",
  "description": "Assist Camp leaders with daily activities",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:39:10.000Z",
  "posted_by": "Karma"
  },
  "8": {
  "opportunity_id": 8,
  "employer": "Edmonds Community Center",
  "category": "Sports and Recreation",
  "event_date": "2021-05-25T04:00:00.000Z",
  "poster_id": 2,
  "title": "Concession Attendant",
  "description": "Sell drinks and snacks to people",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:39:10.000Z",
  "posted_by": "Karma"
  },
  "9": {
  "opportunity_id": 9,
  "employer": "Riverway Sports Complex",
  "category": "Environment",
  "event_date": "2021-06-30T04:00:00.000Z",
  "poster_id": 2,
  "title": "Park Clean Up",
  "description": "Pick up trash and make sure park is clean",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:39:10.000Z",
  "posted_by": "Karma"
  },
  "10": {
  "opportunity_id": 10,
  "employer": "Downtown Vancouver",
  "category": "Health and Wellness",
  "event_date": "2021-05-12T04:00:00.000Z",
  "poster_id": 2,
  "title": "Feeding the Homeless",
  "description": "Hand out food to the homeless",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:39:10.000Z",
  "posted_by": "Karma"
  },
  "12": {
  "opportunity_id": 12,
  "employer": "Team Karma",
  "category": "Health and Wellness",
  "event_date": "2021-05-21T04:00:00.000Z",
  "poster_id": 2,
  "title": "Helping out at Senior Home",
  "description": "Hang out with the Seniors",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:56:44.000Z",
  "posted_by": "Karma"
  }
  },
  "Fine Arts and Culture": {},
  "Sports and Recreation": {
  "7": {
  "opportunity_id": 7,
  "employer": "Bonsor Community Center",
  "category": "Sports and Recreation",
  "event_date": "2021-06-22T04:00:00.000Z",
  "poster_id": 2,
  "title": "Camp Assistant",
  "description": "Assist Camp leaders with daily activities",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:39:10.000Z",
  "posted_by": "Karma"
  },
  "8": {
  "opportunity_id": 8,
  "employer": "Edmonds Community Center",
  "category": "Sports and Recreation",
  "event_date": "2021-05-25T04:00:00.000Z",
  "poster_id": 2,
  "title": "Concession Attendant",
  "description": "Sell drinks and snacks to people",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:39:10.000Z",
  "posted_by": "Karma"
  }
  },
  "Literacy, Libraries, and Learning": {
  "1": {
  "opportunity_id": 1,
  "employer": "Guildford Library",
  "category": "Literacy, Libraries, and Learning",
  "event_date": "2021-05-30T04:00:00.000Z",
  "poster_id": 2,
  "title": "Library Assistant",
  "description": "Be an assistant at a Library",
  "requirements": "1-2 years experience at a library",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-10T21:46:25.000Z",
  "posted_by": "Karma"
  }
  },
  "Environment": {
  "5": {
  "opportunity_id": 5,
  "employer": "Team Karma",
  "category": "Environment",
  "event_date": "2021-05-30T04:00:00.000Z",
  "poster_id": 2,
  "title": "Clean Up Crew Member",
  "description": "Clean up the Fraser river. All clothing and equipment provided",
  "requirements": "No requirements",
  "image_url": "https://coconuts.co/wp-content/uploads/2018/03/dirty-river.jpg",
  "post_date": "2021-05-10T22:35:35.000Z",
  "posted_by": "Karma"
  },
  "9": {
  "opportunity_id": 9,
  "employer": "Riverway Sports Complex",
  "category": "Environment",
  "event_date": "2021-06-30T04:00:00.000Z",
  "poster_id": 2,
  "title": "Park Clean Up",
  "description": "Pick up trash and make sure park is clean",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:39:10.000Z",
  "posted_by": "Karma"
  }
  },
  "Health and Wellness": {
  "10": {
  "opportunity_id": 10,
  "employer": "Downtown Vancouver",
  "category": "Health and Wellness",
  "event_date": "2021-05-12T04:00:00.000Z",
  "poster_id": 2,
  "title": "Feeding the Homeless",
  "description": "Hand out food to the homeless",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:39:10.000Z",
  "posted_by": "Karma"
  },
  "12": {
  "opportunity_id": 12,
  "employer": "Team Karma",
  "category": "Health and Wellness",
  "event_date": "2021-05-21T04:00:00.000Z",
  "poster_id": 2,
  "title": "Helping out at Senior Home",
  "description": "Hang out with the Seniors",
  "requirements": "No requirements",
  "image_url": "https://www.unfe.org/wp-content/uploads/2019/04/SM-placeholder-1024x512.png",
  "post_date": "2021-05-13T20:56:44.000Z",
  "posted_by": "Karma"
  }
  },
  "Computers and Information Technology": {}
};

const categories = {
  "Recommended For You": "recommended",
  "Fine Arts and Culture": "fine-arts",
  "Computers and Information Technology": "computers",
  "Environment": "environment",
  "Health and Wellness": "health",
  "Literacy, Libraries, and Learning": "literacy",
  "Sports and Recreation": "sports"
};

function formatTimestamp(timestamp) {
  let dateObj = new Date(Date.parse(timestamp));
  return returnHighestTimeDiff(dateObj);
}

function returnHighestTimeDiff(time) {
  let ms = {
    y: 31536000000,
    w: 604800000,
    d: 86400000,
    h: 3600000,
    m: 60000,
  }
  let diff = Date.now() - time;
  for(let [key, value] of Object.entries(ms)) {
      if (diff > value) {
          return `${Math.floor(diff/value)}${key}`;
      } else if (diff < ms.m) {
        return "Just now";
      }
  }
}

function formatParams(params) {
  let string = "?";
  let keys = Object.keys(params);
  for(let i=0; i<keys.length; i++) {
    string += `${keys[i]}=${params[keys[i]]}`;
    if (i < keys.legnth - 1) {
      string += "&";
    }
  }
  return string;
}

function view_opportunities(userID) {
  const method = "GET";
  const endpoint = "/opportunities";
  const params = `/${userID}`;
  const url = BASE_URL + endpoint + params;
  APIRequest(method, url); 
}

function send_application(oppObj) {
  let user = get_firebase_info();
  const params = formatParams({
    "id": user.username, // still don't know if a firebase username exists
    "post": oppObj.opportunity_id,
    "msg": document.getElementById("message" + oppObj.opportunity_id).value,
    "email": document.getElementById("email" + oppObj.opportunity_id).textContent,
    "phone": document.getElementById("phone" + oppObj.opportunity_id),
    "city": "Vancouver, British Columbia"
  });
  const method = "POST";
  const endpoint = "/opportunities/applications";
  const url = BASE_URL + endpoint + params
  APIRequestSendApplication(method, url);
}

function APIRequestSendApplication(method, url) {
  console.log(method + ": " + url);
  const xhttp = new XMLHttpRequest();
  xhttp.open(method, url, true);
  xhttp.send();
  xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
          let result = JSON.parse(this.responseText);
          console.log(result);
      }
  }
}


function APIRequest(method, url) {
  console.log(method + ": " + url);
  const xhttp = new XMLHttpRequest();
  xhttp.open(method, url, true);
  xhttp.send();
  xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
          // let result = JSON.parse(this.responseText);
          // console.log("loading post");
          // console.log(result);
          for (const category of Object.keys(categories)) {
            let categoryList = result[category];
            for(const id of Object.keys(categoryList)) {
              loadOpportunity(category, categoryList[id]); 
            }
          }
          
      }
  }
}

function loadOpportunities() {
  for (const category of Object.keys(categories)) {
    let categoryList = result[category];
    for(const id of Object.keys(categoryList)) {
      loadOpportunity(category, categoryList[id]); 
    }
  }
}

function loadOpportunity(category, oppObj) {
  let categoryID = categories[category];
  // console.log(categoryID);
  let categoryDiv = document.getElementById(categoryID + "-opportunities");
  let categoryOuterDiv = document.getElementById(categoryID + "-category");
  categoryOuterDiv.style.display = "block";
  loadModal(oppObj);
  generateOpportunity(oppObj, categoryDiv);
}

function loadModal(oppObj) {
  if (document.getElementById("modal" + oppObj.opportunity_id)) {
    // Break out of function if it already exists
    return;
  }
  let modal = document.getElementById("modalOverlay");

  let content = document.createElement("div");
  content.id = "modal" + oppObj.opportunity_id;
  content.className = "modal-content";
  content.value = "posting";

  let img = document.createElement("div");
  img.className = "modal-column modal-img";
  img.style.backgroundImage = `url('${oppObj.image_url}')`;
  

  let textDiv = document.createElement("div");
  textDiv.className = "modal-column modal-text";
  textDiv.id = "textModal" + oppObj.opportunity_id;

  let close = document.createElement("span");
  let title = document.createElement("p");
  let location = document.createElement("p");
  let description = document.createElement("p");
  let btn = document.createElement("btn");

  close.id = "close" + oppObj.opportunity_id;
  title.id = "modalRole";
  location.id = "modalLocation";
  description.id = "modalDescription";
  btn.id = "modalButton";

  close.className = "close";
  title.className = "heading1";
  location.className = "heading2";
  description.className = "bodytext";
  btn.className = "primarybutton";
  
  close.innerHTML = "&times;";
  title.innerText = oppObj.title;
  location.innerText = "Posted By " + oppObj.employer;
  description.innerHTML = oppObj.description + "<br>" + oppObj.requirements;
  btn.innerText = "Apply to this opportunity";


  btn.onclick = () => {
    displayApplication(oppObj);
  };

  // close.onclick = function () {
  //   hideModal(oppObj.opportunity_id);
  // };

  // textDiv.appendChild(close);
  textDiv.appendChild(title);
  textDiv.appendChild(location);
  textDiv.appendChild(description);
  textDiv.appendChild(btn);

  content.appendChild(img);
  content.appendChild(textDiv);  
  loadApplication(content, oppObj);

  modal.appendChild(content);
}

function displayApplication(oppObj) {
  document.getElementById("application" + oppObj.opportunity_id).style.display = "block";
  document.getElementById("textModal" + oppObj.opportunity_id).style.display = "none";

  document.getElementById("myModal").onclick = () => {
    document.getElementById("textModal" + oppObj.opportunity_id).style.display = "block";
    document.getElementById("application" + oppObj.opportunity_id).style.display = "none";
    hideModal(oppObj.opportunity_id);
  }
}

function loadApplication(content, oppObj) {
  let textModal = document.createElement("div");
  textModal.className = "modal-column modal-text applicationDiv";
  textModal.id = "application" + oppObj.opportunity_id;

  let title = document.createElement("p");
  let nameLabel = document.createElement("p");
  let nameText = document.createElement("p");
  let emailLabel = document.createElement("p");
  let emailText = document.createElement("p");
  let phoneLabel = document.createElement("p");
  let phoneText = document.createElement("input");
  let messageLabel = document.createElement("p");
  let messageText = document.createElement("textarea");
  let btn = document.createElement("btn");

  title.id = "modalRole";
  location.id = "modalLocation";
  btn.id = "modalButton";
  nameText.id = "name" + oppObj.opportunity_id;
  emailText.id = "email" + oppObj.opportunity_id;
  phoneText.id = "phone" + oppObj.opportunity_id;
  messageText.id = "message" + oppObj.opportunity_id;

  title.className = "heading1";
  location.className = "heading2";

  btn.className = "primarybutton";
  nameLabel.className = "applicationLabel";
  emailLabel.className = "applicationLabel";
  phoneLabel.className = "applicationLabel";
  messageLabel.className = "applicationLabel";
  nameText.className = "applicationText";
  emailText.className = "applicationText";
  phoneText.className = "applicationInput";
  messageText.className = "applicationTextArea";

  title.innerText = `Application for ${oppObj.title} with ${oppObj.employer}`;
  nameLabel.innerHTML = "Name";
  emailLabel.innerHTML = "Email";
  phoneLabel.type = "text";
  phoneLabel.innerHTML = "Phone Number";
  messageLabel.innerHTML = "Message";
  // let info = get_firebase_info();
  // nameText.innerHTML = info.name;
  // emailText.innerHTML = info.name;
  // phoneText.innerHTML = info.name;
  nameText.innerHTML = "Marlon Fajardo";
  emailText.innerHTML = "email@email.com";
  phoneText.value = "(778) 123-4567";
  btn.innerText = "Send Application";

  textModal.appendChild(title);
  textModal.appendChild(nameLabel);
  textModal.appendChild(nameText);
  textModal.appendChild(emailLabel);
  textModal.appendChild(emailText);
  textModal.appendChild(phoneLabel);
  textModal.appendChild(phoneText);
  textModal.appendChild(messageLabel);
  textModal.appendChild(messageText);
  textModal.appendChild(btn);
  textModal.style.textAlign = "left";

  content.appendChild(textModal);
}

function get_firebase_info() {
  let info = {};
  firebase.auth().onAuthStateChanged(function (user) {
    db.collection("users")
      .doc(user.uid)
      .get()
      .then(function (doc) {
        let user = doc.data();
        info['name'] = user.name;
        info['email'] = user.email;
        // info['username'] = user.username;  // Does this even exist???
        return info;
      })
      .catch((error) => {
        console.log(`Error getting data: ${error}`);
      });
  });
}

function displayModal(id) {
  var modal = document.getElementById("myModal");
  modal.onclick = function () {
    hideModal(id);
  }
  var content = document.getElementById("modal" + id);
  modal.style.display = "block";
  content.style.display = "flex";
}

function hideModal(id) {
  var modal = document.getElementById("myModal");
  modal.onclick = null;
  var content = document.getElementById("modal" + id);
  modal.style.display = "none";
  content.style.display = "none";
}

function generateOpportunity(oppObj, category) {
  let opportunityRole = document.createElement("p");
  opportunityRole.innerHTML = oppObj.title;
  opportunityRole.setAttribute("class", "heading3");
  opportunityRole.setAttribute("style", "font-weight: 700 !important;");

  let opportunityImgDiv = document.createElement("div");
  opportunityImgDiv.setAttribute("class", "bulletinboardpicture");
  opportunityImgDiv.setAttribute("style", "padding-bottom: 10px");

  let opportunityImg = document.createElement("img");
  opportunityImg.src = oppObj.image_url;
  opportunityImgDiv.appendChild(opportunityImg);

  let opportunityLocation = document.createElement("p");
  opportunityLocation.innerHTML = oppObj.employer;
  opportunityLocation.setAttribute("class", "bodytext");

  let opportunityDiv = document.createElement("div");
  opportunityDiv.setAttribute("class", "opportunity");
  opportunityDiv.setAttribute("style", "margin-bottom: 10px;");
  opportunityDiv.appendChild(opportunityImgDiv);
  opportunityDiv.appendChild(opportunityRole);
  opportunityDiv.appendChild(opportunityLocation);

  category.appendChild(opportunityDiv);

  opportunityDiv.onclick = function () {
    displayModal(oppObj.opportunity_id);
  };
}
